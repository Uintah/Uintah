<html>
<head>
<meta http-equiv="content-type" content="text/html;charset=iso-8859-1">
<meta name="generator" content="Adobe GoLive 4">
<title>Bioelectric Field Simulation</title>
</head>

<body bgcolor="#a9a9a9">
<table align="center" border="0" cellpadding="0" cellspacing="0" width="306" bgcolor="#cccccc">
<tr>
<td><img height="92" width="600" src="images/sub-banner.jpg" border="0" usemap="#sub-banner8662a0c4"><map name="sub-banner8662a0c4"><area coords="581,65,598,84" shape="rect" title nohref><area href="chapter_7.html" coords="557,64,575,83" shape="rect" title="Feedback"><area href="chapter_6.html" coords="532,64,550,82" shape="rect" title="Putting Simulation and Visualization Together"><area href="chapter_5.html" coords="508,64,527,83" shape="rect" title="Bioelectric Field Simulation"><area href="chapter_4.html" coords="483,64,502,83" shape="rect" title="Multi-Vis"><area href="chapter_3.html" coords="460,64,478,83" shape="rect" title="Derived Fields"><area href="chapter_2.html" coords="436,64,454,83" shape="rect" title="Looking at the Data"><area href="chapter_1.html" coords="412,64,430,81" shape="rect" title="Geometry Visualization"><area href="Intro.html" coords="354,64,406,84" shape="rect" title="Introduction"><area href="http://software.sci.utah.edu/doc/index.html" coords="205,63,343,83" shape="rect" title="Documentation"><area href="http://software.sci.utah.edu/" coords="103,63,195,82" shape="rect" title="Software"><area href="index.html" coords="1,65,92,81" shape="rect" title="Tutorial Home"></map></td>
</tr>

<tr>
<td>
<center>
<table border="0" cellpadding="0" cellspacing="5" width="600">
	<tr>
	<td>
	<center>
	<br>
	<font size="4"
	face="Arial,Helvetica,Geneva,Swiss,SunSans-Regular"
	color="maroon">
	<b>Chapter 5: Bioelectric Field Simulation</b></font> </p>
        <p>&nbsp; </p>
        </center>
        <div align="left">
	<p><b><H4><A href="#section 1">Volume conductor problem</H4></b></A>
	<p><b><H4><A href="#section 2">Finite element simulation network</H4></b></A>
	<p><b><H4><A href="#section 3">FEM user interface settings</H4></b></A>
	<p><b><H4><A href="#section 4">Running the simulation</H4></b></A>
	
        <p><b>Chapter Overview</b><br>

        <p>In Chapters 1-4, we worked with dataflow programming,
        and constructed visualization networks for exploring datasets.
        But where did the Field voltage datavalues come from?  In this
        chapter, we will construct a simulation network that computes
        simulated voltages for a realistic volume conductor problem.

	<p>In preceeding chapters, we used modules from the central
        SCIRun package.  Those modules are general purpose
        tools--not targeted towards any specific application.  By
        contrast, in this chapter we begin using modules from the
        BioPSE package, a set of tools specifically written for the
        modeling, simulation, and visualization of bioelectric field
        problems.

	<p>Typically, Packages (<b>Figure 5.1</b>) are logically
	grouped sets of modules and the supporting code for those
	modules.[link to Ug 6.o Packages] Packages can be created by anyone, 
	and compiled into SCIRun. They can be wholly dependent upon SCIRun code, or
	can depend upon any additional third party code.  

	<p>Packages can, in fact, simply wrap around third party code, such that
	SCIRun can use Dataflow functionality. Bridging is the concept that
	SCIRun can be used in conjunction with other useful software
	such as Matlab or Teem. Packages are a major
	mechanism to bridging in SCIRun. 

	</div>
	<center>
	<p><img height="54" width="442" src="images/figures/5_1.gif"><br>
	<b>Figure 5.1</b></p>
	</center>
	<div align="left">
	<p><br>

        <p><b><A name="section 1">Volume conductor problem</b><br></A>

	<p>Given a volume conductor model and an equivalent dipole
	source, we would like to compute the potentials and electric
	field induced by the source through the domain. An analytic
	solution exists for problems of some very specific geometric
	models (<i>e.g.</i>, analytic cylinders or spheres). 
	
	<p>However, for most real-world problems, we can only obtain the solution
	through discretization.  For this application, we will
	discretize our domain into tetrahedral finite elements, where
	each element contains a conductivity tensor that defines how
	electricity travels through its region of the domain.  Within
	each element, we assume a piece-wise linear potential field
	(piece-wise constant electric field).

	<p>The above problem is governed mathematically by Poisson's
	equation:<br>

	<img src="images/equation.gif" align="absbottom"></p>

	<p>where <img height="16" width="11" src="images/sigma.gif">
	is the local conductivity tensor, <img height="16" width="13"
	src="images/phi.gif"> is the voltage over the domain, and <img
	height="19" width="36" src="images/i.gif" align="texttop"> is
	a source term indicating where there are current sources
	within our domain. In plain language, this means: the
	divergence (<img height="16" width="25"
	src="images/del_dot.gif" align="absbottom">) of the electric
	field (<img height="16" width="15" src="images/del.gif"
	align="absbottom"><img height="16" width="13"
	src="images/phi.gif" align="absbottom">) is zero everywhere
	there is not a current source. 

	<p>Discretizing this onto our tetrahedral domain, we approximate the divergence 
	of the electric field with the stiffness matrix <font
	size="4"><b>A</b></font>. <img height="16" width="13"
	src="images/phi.gif"> is a vector composed of voltages at the
	nodes. And <font size="4"><b>b</b></font> is a source vector
	indicating the flux through the nodes -- it is only non-zero
	for nodes that are corners of elements containing a current
	source. Given a stiffness matrix, <font
	size="4"><b>A</b></font>, and a source vector, <font
	size="4"><b>b</b></font>, we can solve the linear system:<br>

	<p><img height="15" width="14" src="images/A.gif"><img
	height="16" width="13" src="images/phi.gif"><img height="16"
	width="20" src="images/equals.gif"><img height="16" width="10"
	src="images/b.gif"><br>

	<p>to determine the potentials,<img height="16" width="13"
	src="images/phi.gif">, through the field. Taking the gradient,
	<img height="16" width="15" src="images/del.gif"><img
	height="16" width="13" src="images/phi.gif">, we get the
	electric field through the domain.<br>

        <p><b><A name="section 2">Finite element simulation network</b><br></A>

	<p>To compute the electric and potential fields given a finite
	element volume conductor mesh and a dipolar current source, we
	follow these steps:<br>
	<ol>
	<li value="1.">Read in the finite element mesh (tet elements, with a
	conductivity tensors for each cell).
	<li value="2.">Read in any dipole sources.
	<li>Construct the finite element stiffness matrix based on
	the conductivity mesh.
	<li>Construct the right hand side source vector based on
	the location and orientation of any dipole sources.
	<li>Solve the linear system <img height="15" width="14"
	src="images/A.gif"><img height="16" width="13"
	src="images/phi.gif"><img height="16" width="20"
	src="images/equals.gif"><img height="16" width="10"
	src="images/b.gif">, to determine the potentials at the nodes.
	</ol>
	<p>Each of the above steps corresponds to a SCIRun module.
	<ul><li>For steps 1 and 2, we will use SCIRun/DataIO/FieldReader
	modules.  
	<li>For step 3, we will use a BioPSE/Forward/SetupFEMatrix module.  
	<li>For step 4, we will use a BioPSE/Forward/ApplyFEMCurrentSource module.  
	<li>And for step 5, we will use a SCIRun/Math/SolveMatrix module.</ul>

	<p>All of these modules should be connected as shown in <b>Figure 5.2</b>.  The User
	Interface settings for each of the modules are described in
	the following sections.

      </div>
	<center>
	<p><img height="461" width="450" src="images/figures/5_2.gif"><br>
	<b>Figure 5.2</b></p>
	</center>
	<div align="left">
	<p><br>


        <p><b><A name="section 3">FEM user interface settings</b><br></A>

	<p>The SetupFEMatrix module constructs a finite element
	stiffness matrix from a tetrahedral volume mesh.  On the UI
	(<b>Figure 5.3</b>)we can choose whether to incorporate the
	local conductivity tensors into the stiffness matrix, or
	whether to use a uniform conductivity.  For this application,
	we will incorporate the local conductivity changes.

	</div>
	<center>
	<p><img height="57" width="158" src="images/figures/5_3.gif"><br>
	<b>Figure 5.3</b></p>
	</center>
	<div align="left">
	<p><br>
	<ol>
	<li value="1.">The ApplyFEMCurrentSource module modifies the right hand
	side vector to account for current sources within the model.
	<li>On the UI (<b>Figure 5.4</b>), you can choose whether the
	current sources are due to a dipole or to a source/sink
	electrode pair.  
	<li>Select the "dipole" setting.</ol>

	</div>
	<center>
	<p><img height="88" width="265" src="images/figures/5_4.gif"><br>
	<b>Figure 5.4</b></p>
	</center>
	<div align="left">
	<p><br>

	<p>The SolveMatrix module solves a linear system using one of
	several linear algebra methods.  
	<ol><li value=1.">Choose the "Conjugate
	Gradient" solver on the UI (<b>Figure 5.5</b>), and set the
	Target Error to 0.0001.
	<li>Set the Maximum Iterations to 200.</ol>
	
	<p><b>Note:</b> the SolveMatrix UI must remain either open or minimized
	while the solver is running; it must not be closed completely.

	<p>For more information on the SolveMatrix module, click on this
	link [link to ?].

	</div>
	<center>
	<p><img height="575" width="250" src="images/figures/5_5.gif"><br>
	<b>Figure 5.5</b></p>
	</center>
	<div align="left">
	<p><br>

	<p>Lastly, for this simulation:
	<ol><li value="1.">Choose the utahtorso-lowres-mesh.tvt.fld Field 
	for the FieldReader on the left. 
	<li>Choose the utahtorso-lowres-dipole.pcv.fld Field for the
        FieldReader on the right.  
	</ol>
	<p>The mesh Field contains the tetrahedral finite element mesh 
	of the Utah Torso model, with conductivity indices stored at each 
	element of the model.  The dipole Field contains a single dipole vector, positioned
        within the torso volume.

        <p><b><A name="section 4">Running the simulation</b><br></A>
		
	<p>With all of the modules connected and the UI state
	configured, you are ready to run the simulation.  
	<ol>
	<li value="1.">Select the "Execute" item from one of the module 
	icon dropdown menus, or:
	<li>Press the "Execute" button on a module's user interface.</ol>
  
	<p>As the simulation progresses, you will see the residual plot in
	the SolveMatrix module converge which is located at the bottom
	of the SolveMatrix UI.  

	<p>Congratulations, you have solved a finite element problem!<br>

	<p><H4><b>Summary</H4></b>
	need content

	<br>
	<br>
	</div>
	</td>
	</tr>
</table>
</center>
</td>
</tr>
<tr>
<td><img height="35" width="600" src="images/sub-banner-bottom.jpg" border="0" usemap="#sub-banner-bottom8ac6e984"><map name="sub-banner-bottom8ac6e984"><area href="chapter_6.html" coords="566,2,589,20" shape="rect"><area href="chapter_4.html" coords="537,1,560,23" shape="rect"><area href="http://www.sci.utah.edu" coords="6,6,68,30" shape="rect" title="SCI Institute"></map></td>
</tr>
</table>
</body>
</html>
