#!/usr/local/bin/python

from os import environ,mkdir,path,system,chdir
from time import asctime,localtime,time
from sys import argv,exit
from helpers.runSusTest import runSusTest,input,modes,num_processes

TESTS = [   ("disks.ups",		    ["dbg", "opt"]),    \
    	    ("disks2mat.ups",		    ["dbg", "opt"]),    \
	    ("disks2mat4patch.ups",	    ["dbg", "opt", "mpi"], 4), \
    	    ("disks2mat_fc.ups",	    ["dbg", "opt"]),    \
    	    ("disks_complex.ups",	    ["dbg", "opt"]),    \
	    ("disks_fracture.ups",	    ["dbg", "opt"]),	\
	    ("periodic_disks.ups",	    ["dbg", "opt"]),	\
	    ("heatcond.ups",		    ["dbg", "opt"]),	\
	    ("heatcond2mat.ups",	    ["dbg", "opt"]),	\
    	    ("inclined_plane_sphere.ups",   ["dbg", "opt"]),	\
	    ("const_test_cmr.ups",	    ["dbg", "opt"]),	\
	    ("const_test_hypo.ups",	    ["dbg", "opt"]),	\
	    ("const_test_nh.ups",	    ["dbg", "opt"]),	\
	    ("const_test_nhp.ups",	    ["dbg", "opt"]),	\
	    ("const_test_vs.ups",	    ["dbg", "opt"]),	\
	    ("sidecrack.ups",		    ["dbg", "opt", "mpi"], 2)	\
    	]

if len(argv) < 2:
    print "usage: %s <mode>" % argv[0]
    print "    where <mode> is a short string used to select tests to run."
    exit(1)
mode = argv[1]

testdir = "%s/MPM-%s" % (environ['BUILDROOT'], mode)
susdir = "%s/SCIRun/src/Packages/Uintah/StandAlone" % (environ['BUILDROOT'])
mkdir(testdir)
chdir(testdir)

failcode = 0

DO_RESTART = "yes"

for test in TESTS:
  if mode not in modes(test):
    continue

  testname = path.splitext(input(test))[0];
  mkdir(testname)
  chdir(testname)

  # Run normal test
  rc = runSusTest(test, mode, susdir, "mpm")
  if rc == 0:
    # Run restart test
    rc = runSusTest(test, mode, susdir, "mpm", DO_RESTART)
    if rc == 1:
	failcode = 1
  else:
    failcode = 1

  chdir("..")

exit(failcode)

