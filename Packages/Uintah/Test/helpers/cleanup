#!/bin/sh

# remove old locks
for BUILDROOT in SCIRun.*; do
  if [ -d "$BUILDROOT" ]; then
    if [ -f "$BUILDROOT/lock" ]; then
      rm $BUILDROOT/lock
    fi
  fi
done

# create locks where *.lock files have symbolic links to
for lock in *.lock; do
  if [ -d "$lock" ]; then
    echo "locked" > "$lock"/lock
  fi
done

# delete all SCIRun.* directories that aren't locked
for BUILDROOT in SCIRun.*; do
  if [ -d "$BUILDROOT" ]; then
    if [ ! -f "$BUILDROOT/lock" ]; then
      cd "$BUILDROOT"
      echo "y" | /usr/local/bin/cvs release -d SCIRun > /dev/null 2>&1
      cd ".."
      rm -srf "$BUILDROOT"
    fi
  fi
done

# delete whatever can be deleted from the trash before adding to it
rm -srf trash

# whatever couldn't get deleted, move to the trash
for BUILDROOT in SCIRun.*; do
  if [ -d "$BUILDROOT" ]; then
    if [ ! -d "trash" ]; then
      mkdir trash
    fi
    if [ ! -f "$BUILDROOT/lock" ]; then
      mv "$BUILDROOT" trash/.
    fi
  fi
done

echo "These need to be removed by their owner"
echo ""
find trash \( ! -user `id -un` \) -prune > trash/need_removal
cat trash/need_removal | xargs ls -ld

# I'm sure there is a better way to get at the user names, but I've spent
# too much time trying to figure it out.
cat trash/need_removal | xargs stat -u | grep "(.*)" > trash/stats
cat trash/stats | sed "s/.*(//g" | sed "s/)//g" | sort -u > trash/usernames

for username in `cat trash/usernames`; do
    sendto=$username
    cat > trash/userRemoval <<EOF
Subject: Cleanup needed for regression tester
To: $sendto

Please remove the following directories in order to clean out the regression tester.

Under `pwd` on `hostname`:

EOF
    find trash -user $username -prune >> trash/userRemoval
    
    /usr/lib/sendmail $sendto < trash/userRemoval
    rm trash/userRemoval
done

#cat trash/uids | xargs -i{UID} find trash -user {UID} -prune > trash/uid{UID}


