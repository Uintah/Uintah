#
#  The contents of this file are subject to the University of Utah Public
#  License (the "License"); you may not use this file except in compliance
#  with the License.
#  
#  Software distributed under the License is distributed on an "AS IS"
#  basis, WITHOUT WARRANTY OF ANY KIND, either express or implied. See the
#  License for the specific language governing rights and limitations under
#  the License.
#  
#  The Original Source Code is SCIRun, released March 12, 2001.
#  
#  The Original Source Code was developed by the University of Utah.
#  Portions created by UNIVERSITY are Copyright (C) 2001, 1994 
#  University of Utah. All Rights Reserved.
#

# Makefile for field manipulation code that is compiled and loaded on the fly

# Default target
default: all

OTF_OBJTOP_ABS    := $(shell cd ../; pwd)

include $(OTF_OBJTOP_ABS)/configVars.mk

OTF_SRCDIR       := @srcdir@
OTF_SRCTOP_ABS   := $(shell cd @srcdir@; pwd)

OTF_SRC := $(OTF_SRCTOP_ABS)
OTF_OBJ := $(OTF_OBJTOP_ABS)

# One level up is the top of the build.
SCIRUN_SRCTOP       := @srcdir@/..
SCIRUN_OBJTOP       := ..

INCLUDES = -I$(SCIRUN_SRCTOP)/include -I$(SCIRUN_SRCTOP) -I$(SCIRUN_OBJTOP) -I$(SCIRUN_SRCTOP)/Packages @INCTCL_H@ @INCTK_H@ @INCITCL_H@ @INCBLT_H@ $(GLOBUS_INCLUDE) $(XML_INCLUDE) $(PETSC_INCLUDES) $(TAU_INCLUDE) $(MPI_INCLUDE)

ifeq ($(SSTREAM_COMPAT),yes)
INCLUDES := $(INCLUDES) -I$(SCIRUN_SRCTOP)/include/compat
endif
INCLUDES := $(sort $(INCLUDES))

LIBDIR := ../lib/

SOFLAGS         := @SOFLAGS@  $(CFLAGS)

SRCS = $(wildcard *.cc)
OTF_OBJS := $(patsubst %.cc,%.o, $(SRCS))
OTF_LIBS := $(patsubst %.cc,%.so, $(SRCS))

ifeq ($(NEED_SONAME),yes)
SONAMEFLAG = -Wl,-soname,$(notdir $@)
else
SONAMEFLAG = 
endif

ifneq ($(MAKECMDGOALS),)
include $(MAKECMDGOALS:so=d)
else
include $(SRCS:.cc=.d)
endif
.SECONDARY:

.PHONY: all
all: $(OTF_LIBS)

%.d: %.cc
	set -e; $(CXX) -M $(CFLAGS) $(INCLUDES) $< \
          | sed 's/\($*\)\.o[ :]*/\1.o $@ : /g' > $@; \
          [ -s $@ ] || rm -f $@

%.o : %.cc %.d
	$(CXX) -c $(CFLAGS) $(INCLUDES) $< -o $@ 

%.so : %.o 
	rm -f $@
	$(CXX) $(CFLAGS) $(INCLUDES) $(SOFLAGS) $< -o $@ 


