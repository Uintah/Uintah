#!/bin/sh

# $BUILD_DIR $BUILDROOT, $HTMLLOG, $NOTESTS, $PARALLELISM, $COMPILE, and $MAKE_PARALLELISM must be set

mode=$1 # dbg or opt
CONFIGURE_ARGS=$2
WithArches="yes"
WithMPMICE="yes"

export WithArches WithMPMICE
retval=0

if [ "$COMPILE" = "yes" ]; then
  if [ ! -d "${BUILDROOT}/${mode}/build" ]; then
    mkdir "${BUILDROOT}/${mode}/build"
  fi
  cd "${BUILDROOT}/${mode}/build"

  rm -f "$BUILDROOT"/${mode}/configure.log

  echo "#!/bin/tcsh" > configure_command
  echo "../../src/configure $CONFIGURE_ARGS" >> configure_command
  chmod a+x configure_command

  retval="0"

  build $mode "$CONFIGURE_ARGS"
  retval=$?

  echo "Changing permissions in `pwd`"
  chgrp -R csafe .
  chmod -R g+rwX . 


fi

if [ "$retval" = "0" -a "$NOTESTS" = "0" ]; then
  run $1
  retval=$?
  chmod -R a+rX "$HTMLLOG"-"$mode"
  exit $retval
else
  exit $retval
fi