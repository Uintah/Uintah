% -*-latex-*-
%
%  The contents of this file are subject to the University of Utah Public
%  License (the "License"); you may not use this file except in compliance
%  with the License.
%
%  Software distributed under the License is distributed on an "AS IS"
%  basis, WITHOUT WARRANTY OF ANY KIND, either express or implied. See the
%  License for the specific language governing rights and limitations under
%  the License.
%
%  The Original Source Code is SCIRun, released March 12, 2001.
%
%  The Original Source Code was developed by the University of Utah.
%  Portions created by UNIVERSITY are Copyright (C) 2001, 1994
%  University of Utah. All Rights Reserved.
%

\chapter{Importing and Exporting \sr{} Data}
\label{ch:import_export} 
\index{importing}
\index{exporting}
\index{converter}

\sr{} does not import or export ``foreign'' data directly. A set of
command line utilities, called \dfn{converters}, import and export
data.  The import utilities convert foreign data to \sr{}  
objects.  The export utilities convert \sr{} objects to
foreign data. The converters import/export the following \sr{} data
types: \datatype{Field}, \datatype{Matrix}, and \datatype{ColorMap}.
Foreign data is text based.

\sr{}'s file-based objects, field export/import mechanics, format of
foreign data files, converter command line options, and converter
synopses are discussed in the following sections.


\section{\sr{} Persistent (File-based) Objects}
\label{sec:sr_file_object}

The objects (fields, matrices, color maps, \etc) \sr{} creates at runtime
store themselves to files as \dfn{persistent objects}.  A persistent
object is a ``snapshot'' of an object's data and state.  Runtime
objects are reconstructed from their persistent file-based cousins.
\sr{}'s persistent objects are also called \sr{} file-based objects.

\sr{}'s persistent objects can be saved in binary form or text form.
\sr{}'s binary objects are built on XDR, a library that abstracts
away the architecture specific facets of data input/output (e.g.
endianness, pointer size, etc).

\note{
  \sr's file-based objects should not be manually edited.  Editing
  these files manually may result in data corruption.}

\sr{}'s converters support most \sr{} file-based objects.  However,
the converters do not support fields containing regular meshes.
Fields with regular meshes can be imported/exported using the
\package{Teem} package.  See \htmladdnormallinkfoot{\package{Teem}
  file format
  documentation}{http://www.cs.utah.edu/~gk/teem/nrrd/format.html} and
\htmladdnormallinkfoot{\package{Teem} module
  descriptions}{\htmlurl{\latexhtml{\scisoftware{}/doc}{../../..}/Developer/Modules/Teem.html}}
for information.

There are two converters for each supported \sr{} type, an import
converter and an export converter.

\section{Exporting a Field}
\label{sec:export_field}

To export a \sr{} field to text files, a \sr{} network and two
converters are used.

Because a field object cannot be exported directly by converters, a
field must first be split into its mesh part, a field object with no
data, and its data part, a matrix object, using a simple \sr{} network
(described below).  Converters are then used to generate text files
containing node locations, connectivity information, and matrix data.

The \sr{} network that splits a field into its mesh and data parts
consists of modules \datatype{FieldReader},
\datatype{ManageFieldData}, and \datatype{MatrixWriter}.  A
\datatype{FieldReader} module reads the field to be split.
\datatype{FieldReader}'s output port is connected to
\datatype{ManageFieldData}'s input port (\datatype{ManageFieldData}'s
matrix input port is unconnected).  \datatype{ManageFieldData}'s
matrix output port is connected to \datatype{MatrixWriter}'s input
port.  The (executed) network saves the field's data as a \sr{} matrix
object.

After a field is split, its mesh and data parts are exported to text
files using field and matrix converters.  A field converter produces
two files: a node location file (a ``pts'' file) and a node
connectivity file (``tri'', ``tet'', ``quad'', or ``hex''
file)\footnote{With the exception of point cloud fields.  They
  contain no connectivity data.}.  A matrix converter produces a file
of data values (``txt'' files).

\secref{Node Location File}{sec:node_loc_fmt} describes the format of
a node location text file.  \secref{Connectivity Files}{sec:node_conn_fmt}
describes the format of a connectivity text file.

\secref{Column Matrix}{sec:colmat}, \secref{Dense
  Matrix}{sec:dense_matrix}, and \secref{Sparse Row
  Matrix}{sparse_row_matrix}, describe the format of matrix text
files.

\section{Importing a Field}
\label{sec:import_field}

To import data from text files into a \sr{} field, two converters and
a simple \sr{} network are used.

A field converter is used to produce an incomplete (node location and
connectivity data only) persistent field object from node location and
node connectivity files.  A matrix converter is used to produce a
persistent matrix object from a node data file.

A complete field (mesh and data) is assembled in \sr{} by constructing
a simple network using modules \datatype{FieldReader},
\datatype{MatrixReader}, \datatype{ManageFieldData}, and
\datatype{FieldWriter}.

A \datatype{FieldReader} module reads the incomplete field object.
\datatype{FieldReader}'s output port is connected to
\datatype{ManageFieldData}'s field input port.  A
\datatype{MatrixReader} is used to read the matrix object.
\datatype{MatrixReader}'s output port is connected to
\datatype{ManageFieldData}'s matrix input port.
\datatype{ManageFieldData}'s field output port is connected to
\datatype{FieldWriter}'s input port (\datatype{ManageFieldData}'s
matrix output port is unconnected).  \datatype{FieldWriter} will write
the complete field object to a file.

\section{Foreign (Text) File Formats}

Converters export/import \dfn{node location files}, \dfn{connectivity
  files}, \dfn{structured mesh files}, \dfn{column matrix}, \dfn{dense
  matrix files}, \dfn{sparse row matrix files} and \dfn{color map
  files}.  All files are human readable text files.  Text file formats
imported and exported by \sr{}'s converters are discussed in following
sections.

\subsection{Node Location File}
\label{sec:node_loc_fmt}

Node location files are called \dfn{pts} files (the file extension is
\filename{.pts}).  A \filename{pts} file defines the coordinate of
each node in a mesh.

The unstructured field converters import/export \filename{pts} files
(converters for structured fields use a \filename{pts} format slightly
different from the format described in this section).

The format is as follows:

\begin{verbatim}
N
x0 y0 z0
x1 y1 z1
    .
    .
    .
xN yN zN
\end{verbatim}

\verb|N| is the number of nodes in the file.  \verb|N| is optional.

On export, option \option{-noPtsHeader} tells an export converter to
omit \verb|N| from the output file.

If \verb|N| is omitted from a file on import, option
\option{-noPtsHeader} must be passed to the import converter.


\subsection{Connectivity Files}
\label{sec:node_conn_fmt}

Five types of node connectivity files exist corresponding to the
unstructured mesh types: \datatype{CurveMesh}, \datatype{TriSurfMesh},
\datatype{QuadSurfMesh}, \datatype{TetVolMesh}, and
\datatype{HexVolMesh}.  The five file formats define
edge, triangular, quadrilateral, tetrahedral, and hexahedral,
elements respectively.  Connectivity files are text files.

Files defining edge elements have the extension \filename{.edge} and
are called \dfn{edge} files.  \dfn{Tri} files define triangular
elements and have the extension \filename{.tri}.  Likewise for
\dfn{Quad}, \dfn{tet}, and \dfn{hex} files.

The unstructured field converters import/export \filename{edge},
\filename{tri}, \filename{quad}, \filename{tet}, and hex connectivity
files.

Connectivity files are formatted as follows:

\begin{verbatim}
N
Node indicies of element 0
Node indicies of element 1
            .
            .
            .
Node indicies of element N
\end{verbatim}

\verb|N| specifies the number of elements in a file.  \verb|N| is
optional.  Converter command line option \option{-noElementsCount} is
used to omit \verb|N| from a connectivity file on export.  The same
command line option is used to tell a converter that \verb|N| is
missing from a text file on import.

Each of the remaining lines specify node indices of one element.
Node indices are assumed to be zero-based unless option
\option{-oneBasedIndexing} is used.  This option can be used with
import and export converters to read ones-based indices on
import or to write ones-based indices on export.

Edge files have two node indices per line, tri files have three, quad
and tet files have four, and hex files have eight node indices per
line.  For example, a tri file looks like the following:

\begin{verbatim}
N
i0 j0 k0
i1 j1 k0
    .
    .
    .
iN jN kN
\end{verbatim}

or like this (with \verb|N|) omitted:

\begin{verbatim}
i0 j0 k0
i1 j1 k0
    .
    .
    .
iN jN kN
\end{verbatim}

%% Needs work!
\subsection{Structured Meshes}

Structured meshes are imported/exported by the converters as node
location (\filename{pts}) files.  Node locations are specified explicitly in a
\filename{pts} file. Connectivities are implicit because node locations are
stored in \dfn{scan-line} order.

For example, in a structured hexahedral mesh, the list of nodes comprising
element \(e_{i,j,k}\) is \(\{n_{i,j,k}, n_{i,j,k+1}, n_{i,j+1,k+1}, n_{i,j+1,k}, n_{i+1,j,k}, n_{i+1,j,k+1}, n_{i+1,j+1,k+1}, n_{i+1,j+1,k}\}\)

% Verify the following paragraph.  See converter source code.
\filename{Pts} files for structured meshes differ slightly
from \filename{pts} files described in \secref{Node Location File
  Format}{sec:node_loc_fmt}.  \filename{Pts} files for
structured meshes specify the number of indices in each dimension of the
mesh. 

A structured curve field (StructCurveField) \filename{pts} file looks
like this:

\begin{verbatim}
NI
x0 y0 z0
x1 y1 z1
    .
    .
    .
xN yN zN
\end{verbatim}

A structured quadrilateral surface field
(StructQuadSurfField) \filename{pts} file looks like this:

\begin{verbatim}
NI NJ
x0 y0 z0
x1 y1 z1
    .
    .
    .
xN yN zN
\end{verbatim}

A structured hexahedral volume field (StructHexVolField)
\filename{pts} file looks like this:

\begin{verbatim}
NI NJ NK
x0 y0 z0
x1 y1 z1
    .
    .
    .
xN yN zN
\end{verbatim}

On export, option \option{-noHeader} tells a converter
(\command{StructCurveFieldToText}, \command{StructQuadSurfFieldToText}, or
\command{StructHexVolFieldToText}) to omit mesh index counts
from the output file.

If node index count values are missing from a file on import, option
\option{-noHeader} must be used.  Option \option{-noHeader} tells the
converter (\command{TextToStructCurveField},
\command{TextToStructQuadSurfField}, or
\command{TextToStructHexVolField}) the mesh index count(s).  Option
\option{-noHeader} is followed by the appropriate mesh index count
values.

\subsection{Column Matrix}
\label{sec:colmat}

The column matrix file format is:

\begin{verbatim}
N
v0 
v1
.
.
.
vN
\end{verbatim}

The converters \command{ColumnMatrixToText} and \command{TextToColumnMatrix} 
export/import column matrices.

\verb|N| is optional.  It specifies the number of matrix rows.  

On export, option \option{-noHeader} tells
\command{ColumnMatrixToText} to omit \verb|N| from the output file.

If \verb|N| is omitted from a file on import, option
\option{-noHeader} must be passed to \command{TextToColumnMatrix}.
Option \option{-noHeader} tells the converter the number of data
values in the matrix.

\verb|N| is followed by a list of data values.

\subsection{Dense Matrix}
\label{sec:dense_matrix}

The dense matrix file format is:

\begin{verbatim}
N M
v(0,0) v(0,1)...v(0,M)
v(1,0) v(1,1)...v(1,M)
        .
        .
        .
v(N,0) v(N,1)...v(N,M)
\end{verbatim}

The programs \command{DenseMatrixToText} and \command{TextToDenseMatrix} 
convert dense matrices to and from text based forms.

\verb|N| and \verb|M| are optional.  \verb|N|, \verb|M| are the number
of matrix rows and columns respectively .  

On export, option \option{-noHeader} tells
\command{DenseRowMatrixToText} to omit \verb|N| and \verb|M| from the
output file..

If \verb|N| and \verb|M| are omitted from a file on import, option
\option{-noHeader N M} must be passed to
\command{TextToDenseMatrix}.

Following \verb|N| and \verb|M| is a list of data values given in row
major order.


\subsection{Sparse Row Matrix}
\label{sparse_row_matrix}

The sparse row matrix file format is:

\begin{verbatim}
NR NC NE
r0 c0 v0
r1 c1 v1
   .
   .
   .
rNE cNE vNE
\end{verbatim}

The programs \command{SparseRowMatrixToText} and
\command{TextToSparseRowMatrix} export/import sparse row matrices.

\verb|NR|, \verb|NC|, and \verb|NE| are optional.  If present, they
specify the number of rows, number of columns, and number of matrix
entries respectively.

On export, option \option{-noHeader} tells
\command{SparseRowMatrixToText} to omit \verb|NR|, \verb|NC|, and
\verb|NE| from the output file.

If \verb|NR|, \verb|NC|, and \verb|NE| are omitted from a file on
import, option \option{-noHeader \ptext{nrows} \ptext{ncols}
  \ptext{nentries}} must be passed to \command{TextToSparseRowMatrix}.

Matrix entries must have ascending row indices. Column indices must be
in ascending order for rows with multiple entries.

\subsection{Color Map}
\label{sec:colormap_fmt}

The color map file format is:

\begin{verbatim}
N
r1 g1 b1 a1 v1
r2 g2 b2 a2 v2
      .
      .
      .
rN gN bN aN vN
\end{verbatim}

The programs \command{ColorMapToText} and \command{TextToColorMap}
export/import color maps.

\verb|N| is optional.  It specifies the number of color map entries in
the file.

On export option \option{-noHeader} tells \command{ColorMapToText} to
omit \verb|N| from the output file.

If \verb|N| is omitted from a file on import, option
\option{-noHeader} must be passed to \command{TextToColorMap}.

Each line following \verb|N| is a color map entry consisting of an RGB
color entry, an alpha value, and a data value.  All RGB, alpha, and
data values are in the range 0.0 to 1.0 inclusive.

\section{Converter Synopses}
\label{sec:converter_synopses}

Converter synopses for unstructured fields, structured fields, matrices,
and color maps are presented in following sections.   Note that
the names of import converters begin with ``TextTo'' (as in
TextToCurveField) and export converters end with ``ToText'' (as in
CurveFieldToText).

If \sr{} is installed from its RPM package, converter commands are
located in \filename{/usr/local/SCIRun/bin}.  If \sr{} is installed
from source code, converter commands are installed in
\ptext{build-dir}\filename{/Standalone/convert}.  \ptext{Build-dir} is
the directory where \sr{}'s \command{configure} and \command{make}
commands were run.

\subsection{Converter Synopses for Unstructured Fields}
\label{sec:unstruct_field_synopses}

In the following synopses, \ptext{field} is the name of a \sr{}
file-based field object, \ptext{pts} is the name of a node location
(\filename{pts}) file, and \ptext{edges}, \ptext{hexes},
\ptext{quads}, \ptext{tets}, and \ptext{tris} are the names of node
connectivity text files.

On export, option \option{-noPtsCount} tells a converter to omit the
node count line from a \filename{pts} output file.  On export, option
\option{-noElementsCount} tells a converter to omit the element count
line from an \filename{edge}, \filename{tri}, \filename{quad},
\filename{tet}, or \filename{hex} output file.  On export, option
\option{-oneBasedIndexing} tells a converter to write ones-based node
indices to an \filename{edge}, \filename{tri}, \filename{quad},
\filename{tet}, or \filename{hex} output file.

On import, option \option{-noPtsCount} tells a converter the node
count line is missing from a \filename{pts} input file.  On import,
option \option{-noElementsCount} tells a converter the element count
line is missing from an \filename{edge}, \filename{tri},
\filename{quad}, \filename{tet}, or \filename{hex} input file.  On
import, option \option{-oneBasedIndexing} tells a converter a
\filename{edge}, \filename{tri}, \filename{quad}, \filename{tet}, or
\filename{hex} input file contains ones-based node indices.

\begin{verbatim}
CurveFieldToText field pts edges [-noPtsCount] [-noElementsCount] [-oneBasedIndexing]

TextToCurveField pts edges field [-noPtsCount] [-noElementsCount] [-oneBasedIndexing]

HexVolFieldToText field pts hexes [-noPtsCount] [-noElementsCount] [-oneBasedIndexing]

TextToHexVolField pts hexes field [-noPtsCount] [-noElementsCount] [-oneBasedIndexing]

PointCloudFieldToText field pts [-noPtsCount]

TextToPointCloudField pts field [-noPtsCount]

QuadSurfFieldToText field pts quads [-noPtsCount] [-noElementsCount] [-oneBasedIndexing]

TextToQuadSurfField pts quads field [-noPtsCount] [-noElementsCount] [-oneBasedIndexing]

TetVolFieldToText field pts tets [-noPtsCount] [-noElementsCount] [-oneBasedIndexing]

TextToTetVolField pts tets field [-noPtsCount] [-noElementsCount] [-oneBasedIndexing]

TriSurfFieldToText field pts tris [-noPtsCount] [-noElementsCount] [-oneBasedIndexing]

TextToTriSurfField pts tris field [-noPtsCount] [-noElementsCount] [-oneBasedIndexing]
\end{verbatim}


\subsection{Converter Synopses for Structured Fields}
\label{sec:struct_field_synopses}

In the following synopses, \ptext{field} is the name of a \sr{}
file-base field object and \ptext{pts} is the name of a node location
(\filename{pts}) file.

On export, option \option{-noHeader} tells a converter to omit
field dimension information from the output file.

On import, option \option{-noHeader} passes field dimension
information to a converter. Use \option{-noHeader} when field
dimension information is missing from the input file.

\begin{verbatim}
StructCurveFieldToText field pts [-noHeader]

TextToStructCurveField pts field [-noHeader ni]

StructQuadSurfFieldToText field pts [-noHeader]

TextToStructQuadSurfField pts field [-noHeader ni nj]

StructHexVolFieldToText field pts [-noHeader]

TextToStructHexVolField pts field [-noHeader ni nj nk]

\end{verbatim}

\subsection{Converter Synopses for Matrices}

In the following synopses, \ptext{matrix-in} and \ptext{matrix-out}
are the names of \sr{} file-based matrix objects or the names
of matrix text files, depending on context.

On export, option \option{-noHeader} tells a converter to omit matrix
dimension information from the output file.

On import, option \option{-noHeader} passes matrix dimension
information to a converter.  Use \option{-noHeader} when matrix
dimension information is missing from the input file.

\begin{verbatim}
ColumnMatrixToText matrix-in matrix-out [-noHeader]

TextToColumnMatrix matrix-in matrix-out [-noHeader]

DenseMatrixToText matrix-in matrix-out [-noHeader]

TextToDenseMatrix matrix-in matrix-out [-noHeader nrows ncols]

SparseRowMatrixToText matrix-in matrix-out [-noHeader]

TextToSparseRowMatrix matrix-in matrix-out [-noHeader nrows ncols nnz]
\end{verbatim}

\subsection{Converter Synopses for Color maps}

In the synopses that follow, \ptext{colormap-in} and
\ptext{colormap-out } are the names of either a \sr{} file-based
matrix object or the name of a matrix text file, depending on context.

On export, option \option{-noHeader} tells a converter to omit the
count of color map entries from the output file.

On import, option \option{-noHeader} passes the number of color map
entries to a converter.  Use \option{-noHeader} when the number of
color map entries is missing from the input file.

\begin{verbatim}
ColorMapToText  colormap-in colormap-out [-noHeader]

TextToColorMap  colormap-in colormap-out [-noHeader]
\end{verbatim}

\section{Examples}
\label{sec:converter_ex}

If \sr{}'s sample data have been installed, data import/export
examples will be found in \directory{SCIRunData/convert-examples}.
Directory \directory{SCIRunData/convert-examples} contains examples of
data that have been converted to/from text and \sr{} formats.  See
\filename{SCIRunData/convert-examples/README} for details.

