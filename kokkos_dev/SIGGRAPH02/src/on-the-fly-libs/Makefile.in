#
#  The contents of this file are subject to the University of Utah Public
#  License (the "License"); you may not use this file except in compliance
#  with the License.
#  
#  Software distributed under the License is distributed on an "AS IS"
#  basis, WITHOUT WARRANTY OF ANY KIND, either express or implied. See the
#  License for the specific language governing rights and limitations under
#  the License.
#  
#  The Original Source Code is SCIRun, released March 12, 2001.
#  
#  The Original Source Code was developed by the University of Utah.
#  Portions created by UNIVERSITY are Copyright (C) 2001, 1994 
#  University of Utah. All Rights Reserved.
#

# Makefile for field manipulation code that is compiled and loaded on the fly

# Default target
default: all

OTF_OBJTOP_ABS    := $(shell cd ../; pwd)

include $(OTF_OBJTOP_ABS)/configVars.mk

OTF_SRCDIR       := @srcdir@
OTF_SRCTOP_ABS   := $(shell cd @srcdir@; pwd)

OTF_SRC := $(OTF_SRCTOP_ABS)
OTF_OBJ := $(OTF_OBJTOP_ABS)

# One level up is the top of the build.
SCIRUN_SRCTOP       := @srcdir@/..
SCIRUN_OBJTOP       := ..

INCLUDES = -I$(SCIRUN_SRCTOP)/include -I$(SCIRUN_SRCTOP) -I$(SCIRUN_OBJTOP) -I$(SCIRUN_SRCTOP)/Packages @INCTCL_H@ @INCTK_H@ @INCITCL_H@ @INCBLT_H@ $(GLOBUS_INCLUDE) $(XML_INCLUDE) $(PETSC_INCLUDES) $(TAU_INCLUDE) $(MPI_INCLUDE)

ifeq ($(SSTREAM_COMPAT),yes)
INCLUDES := $(INCLUDES) -I$(SCIRUN_SRCTOP)/include/compat
endif
INCLUDES := $(sort $(INCLUDES))

LIBDIR := ../lib/

SOFLAGS         := @SOFLAGS@  $(CFLAGS)

#include $(OTF_SRC)/sub.mk
PSELIBS := -lCore_Datatypes -lCore_Persistent -lCore_Exceptions \
	-lCore_Thread -lCore_Containers -lCore_GuiInterface -lCore_Geom \
	-lCore_Datatypes -lCore_Geometry -lCore_TkExtensions \
	-lCore_Math -lCore_Util

LIBS := $(TK_LIBRARY) $(GL_LIBS) $(FLEX_LIBS) -lm $(XML_LIBRARY) $(THREAD_LIBS)

CURRENT_LIBS := $(wildcard ../lib/*.so)
SRCS = $(wildcard *.cc)
OTF_LIBS := $(patsubst %.cc,%.so, $(SRCS))

ifeq ($(NEED_SONAME),yes)
SONAMEFLAG = -Wl,-soname,$(notdir $@)
else
SONAMEFLAG = 
endif


.SUFFIXES: .so .cc

Makefile: $(OTF_SRC)/Makefile.in $(SCIRUN_OBJTOP)/config.status
	@( Here="`pwd`" ; cd $(OTF_SRCTOP_ABS) ; Top="`pwd`" ; CONFIG_FILES="`echo $${Here} | sed -e "s!^$${Top}/!!" -e "s!^$${Top}!.!"`/Makefile" CONFIG_HEADERS="" ./config.status ) 1>&2

%.so : %.cc $(CURRENT_LIBS)
	rm -f $@
	$(CXX) $(CFLAGS) $(INCLUDES) $(CC_DEPEND_REGEN) $(SOFLAGS) $< -o $@ $(CURRENT_LIBS)

$(OTF_LIBS) : $(patsub %.cc,%.so, $@) $(CURRENT_LIBS)

all: $(OTF_LIBS)
