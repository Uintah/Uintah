#!/bin/sh

TEST=$1
MALLOC_STATS=$2
COMPARISON_MALLOC_STATS=$3
TMPDIR=$4

if [ ! -f $MALLOC_STATS ]; then
    echo "No malloc_stats output found.  Can't do memory leak test."
    exit 5
fi

error=0

echo "Checking $TEST for scinew memory leaks"
grep '\.' $MALLOC_STATS > $TMPDIR/scinew_malloc_stats
retval=$?
if [ $retval == "0" ]; then
    echo "***Memory leaks found***"
    echo "Here are the object allocated with scinew but not deleted."
    echo
    cat $TMPDIR/scinew_malloc_stats
    error=1
else
    echo "Memory leak test passed -- no scinew memory leaks found"
    if [ ! -f $COMPARISON_MALLOC_STATS ]; then
        echo "Storing $MALLOC_STATS"
	cp $MALLOC_STATS $COMPARISON_MALLOC_STATS
	exit -1
    fi
    
    echo "Performing highwater memory usage check"
    highwater_check.pl $MALLOC_STATS $COMPARISON_MALLOC_STATS
    error=$?
    if [ $error != "0" ]; then
	echo "***Highwater memory usage check failed***"
        error=2
    else
	echo "Highwater memory usage check passed!"
    fi
fi

exit $error

