#!/bin/sh

TEST=$1
TEST_DIR=$2
COMPARE_ROOT=$3
SUS_DIR=$4

WD=`pwd`
cd $TEST_DIR
UDADIR=`ls -d *.uda`
cd $WD

TEST_UDADIR=$TEST_DIR/$UDADIR
COMPARE_UDADIR=$COMPARE_ROOT/$TEST/$UDADIR

if [ -d "$TEST_UDADIR" ]; then
  if [ ! -d "$COMPARE_ROOT" ]; then
    echo "Creating $COMPARE_ROOT directory"
    COMPARE_PARENT_DIR=`echo "$COMPARE_ROOT" | sed 's|/[^/]*$||'`
    cd $COMPARE_PARENT_DIR
    COMPARE_DIR=`echo "$COMPARE_ROOT" | sed "s|.*/||"`
    mkdir $COMPARE_DIR
#    cvs add $COMPARE_DIR
  fi
  if [ ! -d "$COMPARE_ROOT/$TEST" ]; then
    echo "Creating $COMPARE_ROOT/$TEST directory"
    cd $COMPARE_ROOT
    mkdir $TEST
#    cvs add $TEST
  fi
  if [ ! -d "$COMPARE_UDADIR" ]; then
    echo "Storing uda directory: $COMPARE_UDADIR"

    # try to remove it in case it exists as a non-directory
    rm $COMPARE_UDADIR 

    # if cp has a --dereference option, then us it
    cp -r --dereference $TEST_UDADIR $COMPARE_UDADIR
    if [ $? != "0" ]; then
	# try without --dereference -- not all cp's have this option
	cp -r $TEST_UDADIR $COMPARE_UDADIR
    fi

    chgrp -R csafe "$COMPARE_ROOT/$TEST"
    chmod -R g+rwX "$COMPARE_ROOT/$TEST"

    exit -2
#    find $UDADIR -type d | xargs cvs add
#    find $UDADIR -name "*.dat" | xargs cvs add
#    find $UDADIR -name "*.data" | xargs cvs add
#    find $UDADIR -name "*.xml" | xargs cvs add
#    cvs commit -R -m "Automated Tester storing dat files" $UDADIR
  else
      echo "Testing $TEST"
      compare_sus_runs_by_udas $TEST_UDADIR $COMPARE_UDADIR $SUS_DIR
      exit $?
  fi
else
  echo "$TEST_UDADIR was not created"
  exit 1
fi

exit 0

