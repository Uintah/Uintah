#!/bin/sh

# $BUILD_DIR $BUILDROOT, $HTMLLOG, $NOTESTS, $PARALLELISM, and $MAKE_PARALLELISM must be set

mode=$1 # dbg or opt
CONFIGURE_ARGS=$2
WithArches="yes"
WithMPMICE="yes"

export WithArches WithMPMICE

if [ ! -d "${BUILDROOT}/${mode}/build" ]; then
  mkdir "${BUILDROOT}/${mode}/build"
fi

cd "${BUILDROOT}/${mode}/build"

rm -f "$BUILDROOT"/${mode}/configure.log
echo ""
echo "Starting configure on `date`"
echo "...this is for the ${mode} build using these arguments:"
echo "  $CONFIGURE_ARGS"
echo "#!/bin/tcsh" > configure_command
echo "../../src/configure $CONFIGURE_ARGS" >> configure_command
chmod a+x configure_command

build $mode $CONFIGURE_ARGS
retval=$?
if [ "$retval" = "0" -a "$NOTESTS" = "0" ]; then
  run $1
  exit $?
else
  exit $retval
fi