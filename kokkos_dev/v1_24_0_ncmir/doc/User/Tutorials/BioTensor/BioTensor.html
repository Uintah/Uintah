<!--
   For more information, please see: http://software.sci.utah.edu

   The MIT License

   Copyright (c) 2004 Scientific Computing and Imaging Institute,
   University of Utah.

   License for the specific language governing rights and limitations under
   Permission is hereby granted, free of charge, to any person obtaining a
   copy of this software and associated documentation files (the "Software"),
   to deal in the Software without restriction, including without limitation
   the rights to use, copy, modify, merge, publish, distribute, sublicense,
   and/or sell copies of the Software, and to permit persons to whom the
   Software is furnished to do so, subject to the following conditions:

   The above copyright notice and this permission notice shall be included
   in all copies or substantial portions of the Software.

   THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
   OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
   FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL
   THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
   LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
   FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
   DEALINGS IN THE SOFTWARE.
-->

<!-- 
  This is supposed to be a valid xhtml file!
  Please visit http://validator.w3.org after editing this file (That
  includes *you* Ted).
-->

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta content="HTML Tidy for Mac OS X (vers 1st December 2002), see www.w3.org"
      name="generator" />

    <title>
      BioTensor Tutorial
    </title>

    <style type="text/css">
      body {
      background: #999999;
      margin-top: 0px;
      margin-bottom: 0px;
      }
      div.body {
      background: #CCCCCC;
      margin-left: 8%;
      padding-left: 2%;
      margin-right: 8%;
      padding-right: 2%;
      padding-bottom: 2%;
      padding-top: 2%;
      }
      caption {
      margin-top: 1em;
      }
      table {
      border-collapse: collapse;
      margin-bottom: 1em;
      }
      th {
      text-align: left;
      }
      th, td {
      border: thin solid #999999;
      padding: 2px;
      }
    </style>

  </head>

  <body>
    <div class="body">
      <center>
	<img src="images/biot-banner-main.jpg" height="204" width="600"
	  usemap="biot-banner-main" border="0" alt="Top Banner"/>
	<map id="biot-banner-main" name="biot-banner-main">
	  <area shape="rect" coords="405,170,497,194" href="http://www.sci.utah.edu" alt="SCI Web Site" />
	  <area shape="rect" coords="510,172,590,193" href="http://software.sci.utah.edu"  alt="SCI Software Site" />
	</map>
	<br/>
      </center>
      <h2>
	Contents
      </h2>
      <h3>
	Sections
      </h3>
      <ol>
	<li value="1">
	  <a href="#section_1">Introduction</a>
	</li>
	<li value="2">
	  <a href="#section_2">Getting Started</a> 
	  <ol>
	    <li value="1">
	      <a href="#section_2_1">Preparations</a>
	    </li>
	    <li value="2">
	      <a href="#section_2_2">Launching BioTensor</a>
	    </li>
	    <li value="3">
	      <a href="#section_2_3">User Interface Organization</a>
	    </li>
	  </ol>
	</li>
	<li value="3">
	  <a href="#section_3">Loading Data</a>
	</li>
	<li value="4">
	  <a href="#section_4">Registration of Echo-Planar DWIs</a>
	  <ol>
	    <li value="1">
	      <a href="#section_4_1">Visualizing Mis-registration Problems</a>
	    </li>
	    <li value="2">
	      <a href="#section_4_2">Gradients Data</a>
	    </li>
	    <li value="3">
	      <a href="#section_4_3">Reference Image</a>
	    </li>
	    <li value="4">
	      <a href="#section_4_4">Segmentation Settings</a>
	    </li>
	    <li value="5">
	      <a href="#section_4_5">Fitting Percentage</a>
	    </li>
	    <li value="6">
	      <a href="#section_4_6">Resampling Filter</a>
	    </li>
	    <li value="7">
	      <a href="#section_4_7">Computing Registration</a>
	    </li>
	  </ol>
	</li>
	<li value="5">
	  <a href="#section_5">Building Tensors (Tensor Estimation)</a>
	  <ol>
	    <li value="1">
	      <a href="#section_5_1">DWI Smoothing</a>
	    </li>
	    <li value="2">
	      <a href="#section_5_2">Masking Threshold</a>
	    </li>
	    <li value="3">
	      <a href="#section_5_3">B-Matrix</a>
	    </li>
	    <li value="4">
	      <a href="#section_5_4">Build Tensors</a>
	    </li>
	  </ol>
	</li>
	<li value="6">
	  <a href="#section_6">Visualization</a> 
	  <ol>
	    <li value="1">
	      <a href="#section_6_1">Rendering Window</a>
	    </li>
	    <li value="2">
	      <a href="#section_6_2">Planes</a>
	    </li>
	    <li value="3">
	      <a href="#section_6_3">Isosurface</a>
	    </li>
	    <li value="4">
	      <a href="#section_6_4">Glyphs</a>
	    </li>
	    <li value="5">
	      <a href="#section_6_5">Fibers</a>
	    </li>
	  </ol>
	</li>
      </ol>
      <h3>Appendices</h3>
      <ol type="A">
	<li><a href="#appendix_a">Image Formats and Preparation</a></li>
	<li><a href="#appendix_b">B-Matrix File Format</a></li>
      </ol>
      <h3>Tables</h3>
      <ul>
	<li>
	  <a href="#table_1">Rendering Window's Mouse Controls</a>
	</li>
      </ul>
      <h3>
	Figures
      </h3>
      <ul>
	<li>
	  <a href="#figure_1">Figure 1: BioTensor Interface
	    Window</a>
	</li>
	<li>
	  <a href="#figure_2">Figure 2: BioTensor Interface
	    Window (Detached Panes)</a>
	</li>
	<li>
	  <a href="#figure_3">Figure 3: File Menu</a>
	</li>
	<li>
	  <a href="#figure_4">Figure 4: Help Menu</a>
	</li>
	<li>
	  <a href="#figure_5">Figure 5: File Load Dialog</a>
	</li>
	<li>
	  <a href="#figure_6">Figure 6: Registration Tab</a>
	</li>
	<li>
	  <a href="#figure_7">Figure 7: Registration Improvement</a>
	</li>
	<li>
	  <a href="#figure_8">Figure 8: Final Processing Stage</a>
	</li>
	<li>
	  <a href="#figure_9">Figure 9: Cutting Plane
	    Visualization</a>
	</li>
	<li>
	  <a href="#figure_10">Figure 10: Isosurface
	    Visualization</a>
	</li>
	<li>
	  <a href="#figure_11">Figure 11: Clipped Plane
	    Visualization</a>
	</li>
	<li>
	  <a href="#figure_12">Figure 12: Glyph Box
	    Visualization</a>
	</li>
	<li>
	  <a href="#figure_13">Figure 13: Super quadric Glyph
	    Visualization</a>
	</li>
	<li>
	  <a href="#figure_14">Figure 14: Fiber
	    Visualization</a>
	</li>
	<li>
	  <a href="#figure_15">Figure 15: Single Fiber</a>
	</li>
	<li>
	  <a href="#figure_16">Figure 16: Planes and
	    Fibers</a>
	</li>
      </ul>

      <a name="section_1" id="section_1"/>
      <h2>Section 1&mdash;Introduction</h2>

      <p>
	BioTensor is a program that processes and visualizes diffusion tensor
	images. It can read diffusion weighted images (DWIs), perform
	correction for a common class of distortions in echo-planar imaging,
	estimate tensors from DWIs, and visualize the diffusion tensor
	field. BioTensor's functionality is easily extended. Future
	versions will have expanded capabilities based on contributions from
	external collaborators and internal development.
      </p>
      <p>
 	Diffusion weighted imaging uses the diffusion of water
	molecules to probe the directional micro-structure of living
	tissue. A single diffusion weighted image generally measures
	diffusivity of water molecules along a particular
	direction. The amount of diffusion along a direction is
	detected by destructive interference of different phase
	signatures created by the magnetic gradient. A large set of
	DWIs along carefully chosen gradient directions permits
	estimation of a diffusion tensor that models the relationship
	between direction and diffusivity. The BioTensor application
	generates "diffusion tensor images" (DTIs) from DWIs.  DTIs
	are three-dimensional fields of tensor values. Seminal papers
	on diffusion tensor imaging, written by Peter Basser and
	others, can be found
	<a href="http://dir2.nichd.nih.gov/nichd/stbb/publications.html">
	  here</a>.
      </p>
      <p>
	An important application of diffusion tensor imaging is determining
	the connective structure of central nervous tissue, made possible by
	the directionally constrained diffusion of water within or between the
	myelinated axon sheaths of white matter. The extent to which diffusion
	is faster along some directions than others is termed anisotropy;
	white matter within the brain is more anisotropic than gray matter on
	its cortical surface. The visualization capabilities in BioTensor
	allow the user to:
      </p>
      <ul>
	<li>
	  <p>Visualize individual tensor samples.</p>
	</li>
	<li>
	  <p>
	    Determine the over-all shape of anisotropic regions through
	    isosurfaces of different anisotropy metrics.
	  </p>
	</li>
	<li>
	  <p>
	    Trace the connectivity along white matter tracts by forming paths that
	    follow the tensor principal eigenvector, or use the tensor-line
	    algorithm.
	  </p>
	</li>
      </ul>

      <p>
	This tutorial demonstrates many of BioTensor's capabilities.
	BioTensor is used in this tutorial to process diffusion weighted images
	acquired using the echo-planar imaging method.  These data  are part
	of the SCIRun sample data set collection and may be <a
	  href="http://software.sci.utah.edu/archive_entry.html">obtained</a>
	from SCI's web site.
      </p>

      <a name="section_2" id="section_2"/>
      <h2>Section 2&mdash;Getting Started</h2> 
      <p>
	This section demonstrates how to start BioTensor. Subsequent
	sections demonstrate how to load, process, and visualize data.
      </p>

      <h3>
	<a name="section_2_1" id="section_2_1" />
	2.1 Preparations
      </h3>

      <p>
	Before starting the tutorial a number of preparations must be made.
	First, set the following environment variables:
      </p>
      <dl>
	<dt>SCIRUN_DATA</dt>
	<dd>
	  SCIRUN_DATA points to the sample data sets directory.  This tutorial
	  assumes the SCIRun sample data directory is
	  <tt>/usr/sci/data/SCIRunData/1.22.0</tt>.
	  
	  <p>For a csh-like shell:</p>

	  <pre>
  setenv SCIRUN_DATA /usr/sci/data/SCIRun/SCIRunData/1.22.0
	  </pre>

	  <p>For a sh-like shell:</p>

	  <pre>
  export SCIRUN_DATA=/usr/sci/data/SCIRun/SCIRunData/1.22.0
	  </pre>
	</dd>
	<dt>SCIRUN_DATASET</dt>
	<dd>
	  SCIRUN_DATASET points to a specific data set directory within the data
	  directory.  The tutorial requires SCIRUN_DATASET to be set to the
	  "brain-dt" dataset:

	  <p>For a csh-like shell:</p>

	  <pre>
  setenv SCIRUN_DATASET brain-dt
	  </pre>

	  <p>For a sh-like shell:</p>

	  <pre>
  export SCIRUN_DATASET=brain-dt
	  </pre>
	</dd>

<!-- 	<dt>SCIRUN_ON_THE_FLY_LIBS_DIR</dt> -->
<!-- 	<dd> -->
<!-- 	  SCIRUN_ON_THE_FLY_LIBS_DIR points to an "on the fly libs" directory. -->
<!-- 	  It should be set as follows: -->
<!-- 	  <pre> -->
<!--   mkdir ~/on-the-fly-libs -->
<!-- 	  </pre> -->

<!-- 	  <p>For a csh-like shell:</p> -->
<!-- 	  <pre> -->
<!--   setenv SCIRUN_ON_THE_FLY_LIBS_DIR ~/on-the-fly-libs -->
<!-- 	  </pre> -->
<!-- 	  <p>For a sh-like shell:</p> -->
<!-- 	  <pre> -->
<!--   export SCIRUN_ON_THE_FLY_LIBS_DIR=~/on-the-fly-libs -->
<!-- 	  </pre> -->
<!-- 	</dd> -->
      </dl>

      <h3>
	<a name="section_2_2" id="section_2_2">2.2 Launching
	  BioTensor</a>
      </h3> 
      <p>
	To launch the BioTensor application, change the current
	working directory (using the <b>cd</b> command) to the
	directory containing the
	BioTensor executable.  The directory for an RPM installation
	is /usr/local/SCIRun/bin/.
	</p>
      <p>
	Type <tt>./BioTensor</tt> to start the program.  BioTensor takes
	a few moments to start up, then launches a user interface window
	shown in <a href="#figure_1">Figure 1</a>.  
      </p> 

      <a name="figure_1" id="figure_1"></a>
      <center>
	<a href="figures/biotensor-load2.gif">
	  <img border="1"
	    src="figures/biotensor-load2-small.gif" width="600" height="362" alt="Figure 1: BioTensor
	    Interface Window (Initial State)."/> 
	</a>
	<br/>
	<b>Figure 1: BioTensor Interface Window initial
	  state  <br />Click on image for a larger view</b>
      </center>
      <br />
      <br />

      <h3>
	<a name="section_2_3" id="section_2_3">2.3 User
	  Interface Organization</a>
      </h3>

      <p>
	BioTensor's user interface, shown in <a
	href="#figure_1">Figure 1</a>, contains three panes.  The left
	pane is the Processing Pane. It guides the user through the
	application. The center pane is the Rendering Pane. Data
	interaction and visualization is performed here. The right
	pane is the Visualization Pane. It controls parameters for the
	Rendering Pane.
      </p>
      <p>
	The panes may be "detached" from one another by clicking on the
	pane detachment/attachment controls&mdash;these are the vertical dashed
	lines separating the panes.  When separated, the panes appear as shown
	in <a href="#figure_2">Figure 2</a> <a name="figure_2"
	  id="figure_2"></a>.  Detaching the Rendering window allows it to
	be viewed at maximum resolution.  Panes are re-attached by 
	clicking on the pane detachment/attachment controls.
      </p>

      <center>
	<a href="figures/biotensor-panes2.gif"><img border="1"
	    src="figures/biotensor-panes2-small.gif" width="623" height="381" alt="Figure 2: BioTensor
	    Interface Window (Panels Detached From View Window)."/> 
	</a>
	<br/>
	<b>Figure 2: BioTensor Interface Window.  Detached panels.
	  <br /> Click on image for a larger view.</b>
      </center>
      <br/>

      <p>
	The Processing Pane has two top-level menus: File and Help, as
	shown in <a href="#figure_3">Figures 3</a> and <a
	  href="#figure_4">4</a>. 
      </p>

      <p>
	File menu items Save Session... and Load Session... allow the
	user to stop and resume BioTensor sessions.  After loading a
	saved session with Load Session..., resume processing and
	visualization by clicking Execute.
      </p>

      <p>
	Help menu item Show Tooltips toggles tooltips. "Hovering" the
	mouse pointer over a control
	displays a tooltip describing a control.
      </p>

      <a name="figure_3" id="figure_3"></a>
      <center>
	<img border="1"
	  src="figures/biotensor-file.gif" alt="Figure 3: File Menu."/>
	<br/>
	<b>Figure 3: File Menu.</b>
      </center>

      <br/><br/><br/>

      <a name="figure_4" id="figure_4"></a>
      <center>
	<img border="1"
	  src="figures/biotensor-help.gif" alt="Figure: Help Menu."/>
	<br/>
	<b>Figure 4: Help Menu.</b>
      </center>
      <br/>

      <p>
	The bottom of the Processing Pane contains a Progress
	Indicator, a text description indicating the current
	state of the application, and suggests the next processing
	step.
      </p>

      <p>
	Just above the Progress Indicator are two buttons: an Execute
	 button and a Next button. Press the Execute button to
	 complete the current processing step.  Press the Next button to begin
	 the next processing step.
      </p>

      <p>
	The Progress Indicator  indicates an error if an error occurs.  Clicking
	on the Progress Indicator displays an error log.
      </p>

      <a name="section_3" id="section_3"/>
      <h2>
	Section 3&mdash;Loading Data
      </h2>

      <p>
	BioTensor can be used to process raw DWI images, producing DTI data
	for visualization. Pre-computed Tensor data can be loaded into
	BioTensor for immediate investigation (bypassing processing stages).
	BioTensor supports the NRRD, Analyze, and DICOM data formats.  <a
	  href="#appendix_a">Appendix A</a> gives more information on supported
	image formats.
      </p>

      <p>
	Note: if your environment variables are set correctly, you can
	skip steps 1-4. Otherwise, to load data for this tutorial:
      </p>
      <ol>
	<li><p>Click on the Processing Pane's Load Data tab.</p></li>
	<li><p>Click the radio button labeled: DWI with separate B0 Reference Data.</p></li>
	<li><p>Click on the Load Data panel's Nrrd tab.</p></li> 
	<li><p>Use the Nrrd panel's Browse buttons to select DWI data, 
	    <tt>/usr/sci/data/SCIRunData/1.22.0/demo-DWI.nrrd</tt>, and B0 data,
	    <tt>/usr/sci/data/SCIRunData/1.22.0/demo-B0.nrrd.</tt></p></li>
      </ol>

      <p>
	Each Browse button invokes a file selection dialog like the one shown
	in <a href="#figure_5">Figure 5</a>. After selecting the desired file,
	click the Set button n the file selection dialog.  The UI will close.
      </p>

      <p>
	Notes:
      </p>
      <ul>
	<li>
	  <p>
	    Load pre-computed diffusion tensor data by clicking the
	    radio button labeled: Load Tensor Volumes.  Pressing this
	    radio button skips processing steps, and tensor volume data
	    may be visualized directly (as described in <a
	    href="#section_6">Section 6</a>)
	  </p>
	</li>
	<li>
	  <p>
	   Load  DICOM or Analyze format data using the Dicom and Analyze
	    panels, respectively.</p>
	</li>
      </ul>
      <br/>

      <a name="figure_5" id="figure_5"/>
      <center>
	<img border="1"
	  src="figures/biotensor-load-browse.jpg" 
	  alt="Figure: File Load Dialog."/>
	<br/>
	<b>Figure 5: File Load Dialog.</b>
      </center>
      <br/><br/>

      <p>
	After selecting DWI and B0 data, click the Processing Pane's Execute
	button at the bottom of the pane. Data are loaded and an image appears
	in the Rendering window. This image shows the variance between the
	different DWI component volumes for a specific slice
	location. Variance values are color-coded: areas of low variance are
	black, areas with medium variance are orange, and areas of high
	variance are white.  With the slider in the Visualization panel,
	select different slices from the volume to inspect.
      </p>
      <p>
	Performing distortion correction on the DWI channels is the
	next step in the BioTensor application.  Press the yellow Next
	button at the bottom of the Processing pane to proceed to the
	registration processing step.
      </p>

      <a name="section_4" id="section_4"/>
      <h2>
	Section 4&mdash;Registration of Echo-Planar DWIs
      </h2> 
      <p>
	Many diffusion weighted images are acquired with a fast method
	known as echo-planar imaging (EPI). This type of imaging can
	suffer from two kinds of distortion: global distortions due to
	eddy currents, and local distortions due to susceptibility
	artifacts.  BioTensor can correct the first type of
	distortion.  Future versions may include field-map based
	correction of the second type of distortion. BioTensor assumes the X direction is the read-out
	direction, and the Y direction is the phase-encoding
	direction, along which EPI distortions occur.  <a
	href="#figure_6">Figure 6</a> shows the Processing pane's
	Registration tab. "Check" the Registration tab's "Perform
	Global EPI Registration" check-box to perform EPI
	registration.  The following sections describe each
	registration parameter.  This tutorial assumes use of default
	registration settings.
      </p>

      <a name="figure_6" id="figure_6"></a>
      <center>
	<img border="1"
	  src="figures/biotensor-processing.jpg"
	  alt="Figure: Registration Tab."/>
	<br/>
	<b>Figure 6: Registration Pane.</b>
      </center>
      <br/><br/>

      <h3 id="section_4_1">4.1 Visualizing Mis-registration Problems</h3>
      <p>
	Visualizing the variance at each voxel across the DWIs, can
	indicate problems due to poor DWI registration as shown in <a
	href="#figure_6">Figure 6</a>.  To view the variance, select
	the Vis Options tab.  Then select the Variance tab.  Now
	select the "View Variance of Original Data" check-box. DWI
	variance is a simple indicator of anisotropy, because
	isotropic regions should generate constant DWI values for all
	gradient directions. Note, however, the regions of high
	spurious ("ghost") anisotropy at the top (anterior) and bottom
	(posterior) edges of the brain, due to DWI mis-registration.
       </p>

      
      <h3 id="section_4_2">4.2 Gradients Data</h3>
      <p>
	The method for registering EPI acquired images looks at
	over-all brain cross-section changes across the DWIs to
	estimate (and correct for) the distortion caused by eddy
	currents. The list of gradient directions associated with each
	DWI (the direction along which the image is sensitized to
	diffusion) is the first piece of information required at this
	stage. This is given as the "Gradients File:". This is a
	plain text file, with three numbers per line, giving the X, Y,
	and Z components of the gradient. There must be one line per
	DWI.
     </p>

      <h3 id="section_4_3">4.3 Reference Image</h3>
      <p>
	The registration method can perform implicit registration with
	the reference (B=0) image, or it can use a diffusion weighted
	image chosen by the user.  Select the implicit registration
	method by clicking on radio button Implicit Reference.  To use
	a diffusion weighted image, click Choose Reference
	Image. Then, use the slider labled Choose Reference Image to
	choose an image (note that DWIs are sequentially numbered,
	starting with 1).
      </p>
      <p>
	Implicit registration models the relationship between gradient
	directions and the resulting distortion, allowing implicit
	registration to map DWIs to the coordinate space of the B=0
	image without explicitly registering with it.
      </p>
      <p>
	When using a diffusion weighted image, choose the image least
	affected by EPI distortion.
      </p>
 

      <h3 id="section_4_4">4.4 Segmentation Settings</h3>
      <p>
	The registration method's estimate of the over-all shape of the brain
	cross-section is based on a simple segmentation of the
	DWIs. Segmentation is performed as some amount of Gaussian smoothing
	along the X and Y directions, followed by a thresholding of the DWI
	value, followed by (optional) connected component analysis. Each step
	is represented in the UI.
      </p>
      <p>
	The X and Y sliders located within the Gaussian Smoothing box,
	control the radius (standard deviation) of the Gaussian
	smoothing along the X and Y directions. Some amount of
	smoothing helps the thresholding find more accurate estimates
	of the brain cortical outline. Too much smoothing distorts the
	estimate of cortical shape due to anisotropy in the underlying
	white matter. The preset defaults work well.
      </p>
      <p>
	The threshold DWI value, between background and brain tissue,
	can be automatically determined by clicking the radio button
	labeled Automatically Determine Threshold in the
	Background/DWI Threshold box.  A threshold value may be
	specified by clicking the radio button labeled Specify
	Threshold, and entering a threshold value.
      </p>
      <p>
	The Use Connected Components check box determines whether connected
	component analysis is done to refine the thresholding output. Using
	connected components is helpful because it leads to estimates of the
	brain cross-section shape that are more similar across the diffusion
	weighted images.
      </p>


      <h3 id="section_4_5">4.5 Fitting Percentage</h3>
      <p>
	Based on the segmentation of the brain interior, the
	registration method estimates the distortion on each slice of
	the DWI volumes. To improve the robustness, a linear fitting
	of the distortion parameters across the slices is
	performed. This allows better distortion correction on slices
	where the brain cross-section shape was poorly segmented,
	leading to poor distortion estimation on that single
	slice. The algorithm internally generates a measure of
	segmentation quality, and uses some fraction of slices (those
	with the best segmentation) as reference when performing the
	linear fit of distortion parameters across slices. With the
	Fitting percentage slider, specify how many slices should
	contribute to the fitting, versus how many slices (with the
	poorest segmentation results) should be ignored. The default
	setting works well.
      </p>


      <h3 id="section_4_6">4.6 Resampling Filter</h3>
      <p>
	The filter used when applying the warp to the individual images is the
	final parameter in the registration method. In order of ascending
	quality (and decreasing speed), the choices are:
      </p>
      <ul>
	<li>
	  <p>Linear (linear interpolation)</p>
	</li>
	<li>
	  <p>Catmull-Rom (cubic interpolation)</p>
	</li>
	<li>
	  <p>Windowed Sinc (Hann window with 8-sample radius)</p>
	</li>
      </ul>
      <p>
	Use the pop-up menu labeled Resampling Filter to choose a filter.
      </p>

      <h3 id="section_4_7">4.7 Computing Registration</h3>
      <p>
	Press "Execute" after registration parameters have been set.  Due to the
	complexity of the process,  registration can take some time.
      </p>
      <p>
	Once registration is finished, visualize the improvement, as shown in
	<a href="#figure_7">Figure 7</a>, by selecting the "View Variance of
	Registered Data" check-box in the visualization pane. This shows, side
	by side, slices of DWI variance before and after registration. Note
	the reduction of spurious anisotropy at the edges of the brain.
      </p>
      <p>
	Press Next to go to the next step&mdash;building tensors.
      </p>

      <a name="figure_7" id="figure_7"/>
      <center>
	<img border="1"
	  src="figures/biotensor-registration-done.jpg" 
	  alt="Figure: Registration Improvement."/>
	<br/>
	<b>Figure 7: Registration Improvement.</b>
      </center>
      <br />

      <a name="section_5" id="section_5"/>
      <h2>Section 5&mdash;Building Tensors (Tensor Estimation)</h2>


      <p>
	The final processing step combines the diffusion weighted
	images to estimate diffusion tensors at each sample point.  <a
	href="#figure_8">Figure 8</a> shows the Processing Pane and
	the Rendering Pane at the final step of processing.   Note the
	Processing Pane's Build Tensors tab is selected.  Following
	sub-sections discuss the DWI smoothing, masking threshold, and
	B-matrix parameters.  Press Execute after setting these
	parameters to compute tensors. 
      </p>

      <a name="figure_8" id="figure_8"/>
      <center>
	<img border="1"
	  src="figures/biotensor-build.jpg" 
	  alt="Figure: Final Processing Stage."/>
	<br/>
	<b>Figure 8: Final Processing Stage.</b>
      </center>

      <h3 id="section_5_1">5.1 DWI Smoothing</h3>
      <p>
	Visualization and analysis stages sometimes benefit from
	smoothing of the individual DWIs prior to estimation of
	tensors. The checkbox labeled Do Smoothing enables Gaussian
	blur of the DWIs by controlling the radius (the standard
	deviation) of the Gaussian kernel within the slice plane and
	across slices.  The slider labeled Radius in X and Y controls
	the Gaussian kernel radius within the slice plane.  The slider
	labeled Radius in Z controls the Gaussian kernel radius across
	slices.
      </p>

      <h3 id="section_5_2">5.2 Masking Threshold</h3>
      <p>
	Diffusion tensors can not be meaningfully
	calculated in the background (air) of DWIs. The
	non-diffusion-weighted image and DWIs do not have significant
	signal in the background. Diffusion tensors can be calculated
	inside the CSF (cerebrospinal fluid), but they do not record
	interesting anatomical structure. In both regions, the value
	of DWIs is small compared to values inside the
	brain. BioTensor masks the tensor field based on the mean DWI
	value, so the regions do not appear in later
	visualizations.
      </p>
      <p>
	To allow BioTensor to automatically find a threshold (by
	histogram analysis), click the radio button labeled
	Automatically Determine Threshold.  To specify a threshold,
	click the radio button labeled Specify Threshold and enter a
	threshold value.  Note: tensors are computed for all voxels;
	the DWI masking produces a separate scalar field that
	BioTensor uses for controlling visualization, but does not
	scale tensors themselves.
      </p>

      <h3 id="section_5_3">5.3 B-Matrix</h3>
      <p>
	To estimate tensors from DWIs, the relationship between each
	DWI and the diffusion tensor must be known. The B-matrix is a
	matrix that captures the weighting that each diffusion tensor
	coefficient received in a given DWI. BioTensor currently
	refers to the list of B-matrices for all DWIs as the
	"B-Matrix".  B-Matrix information can be communicated to
	BioTensor in two ways.
      </p>
      <p>
	Assuming diffusion weighting caused by imaging gradients is
	negligible, the B-Matrix can be computed directly from the
	list of gradient directions used previously for EPI
	registration. Note: in this case, the first image among the
	DWIs is assumed to be the reference T2 image, which exhibits
	no diffusion weighting, and the B-matrix is assumed to be all
	zeros ("B=0").  To let BioTensor compute the B-Matrix, click
	the radio button labeled Compute B-Matrix Using Gradients
	provided
      </p>

      <p>
	If a B-matrix has been computed for each DWI from both imaging
	gradients and diffusion-encoding gradients, it can be loaded
	as a separate text ("Load B-Matrix").  To load a pre-computed
	B-Matrix file, click the radio button labeled Load B-Matrix,
	and enter the name of a B-Matrix file.  <a
	href="#appendix_b">Appendix B</a> discusses the format of a
	B-Matrix file.
      </p>

      <h3 id="section_5_4">5.4 Build Tensors</h3>
      <p>
	Currently, BioTensor performs linear least-squares fitting to estimate
	the diffusion tensors at each sample point. Non-linear tensor
	estimation will be included in an upcoming version.
      </p>
      <p>
	Press the Execute button to compute the DT volume and begin
	visualization.
      </p>

      <a name="section_6" id="section_6"/>
      <h2>Section 6&mdash;Visualization</h2>

      <p>
	As the visualization stage begins, the system computes a
	number of derived quantities. This may take several minutes,
	during which time, the Progress indicator shows that the
	system is busy.  One of the first quantities the system
	renders, is a set of three orthogonal cutting planes through
	the DT volume. Begin interacting with the visualization when
	the Progress Indicator shows that compuations are
	complete.
      </p>

      <a name="section_6_1" id="section_6_1"/>
      <h3>6.1 Rendering Window</h3>

 <!-- Need figure of Viewer options tab. -->
     <p>
	To visualize data, press the AutoView button to move the
	rendered geometry into the middle of the window, or press
	Ctrl-V while the mouse is in the Rendering window. The
	AutoView button is located on the Viewer Options tab.
      </p>
      <p>
	Interaction with the Rendering window is performed with the
	mouse.  The Rendering window's scene can be translated,
	zoomed, rotated, etc.  <a href="#table_1">Table 1</a> shows
	mouse actions for controlling the Rendering window.  Controls
	for navigating within the Rendering window are similar to the
	SCIRun <a
	href="http://software.sci.utah.edu/doc/User/Guide/usersguide/srug6_1.html">Viewer</a>.
	However, the full control pane normally found at the bottom of
	the SCIRun ViewWindow, has been replaced with the most
	frequently used subset of those controls, and is located on
	the Viewer Options tab.
      </p>

      <a name="table_1" id="table_1"/>
      <center>
	<table>
	  <caption><b>Table 1</b>: Rendering Window's Mouse Controls</caption>
	  <thead>
	    <tr>
	      <th>Modifier Key</th>
	      <th>Mouse Button</th>
	      <th>Renderer Window Action</th>
	    </tr>
	  </thead>
	  <tbody>
	    <tr>
	      <td rowspan="3">none</td>
	      <td>Left</td>
	      <td>Translate scene</td>
	    </tr>
	    <tr>
	      <td>Middle</td>
	      <td>Rotate scene</td>
	    </tr>
	    <tr>
	      <td>Right</td>
	      <td>Zoom scene</td>
	    </tr>
	    <tr>
	      <td rowspan="3">Control</td>
	      <td>Left</td>
	      <td>Translate scene in Z-direction</td>
	    </tr>
	    <tr>
	      <td>Middle</td>
	      <td>Rotate the camera view about the eye point</td>
	    </tr>
	    <tr>
	      <td>Right</td>
	      <td>Unicam movement</td>
	    </tr>
	  </tbody>
	</table>
      </center>

      <p>
	Within the Vis Options tab of the Visualization pane, there
	are five sub-tabs for controlling visualization settings. The
	first tab, "Variance", was used in Section 3 to visualize DTI
	variance data. The following sections investigate options on
	the Planes, Isosurface, Glyphs, and Fibers tabs.
      </p>

      <a name="section_6_2" id="section_6_2"></a>
      <h3>6.2 Planes Visualization</h3>

      <p>
	By default, the cutting planes render when the visualization
	pre-processing stage completes, as shown in <a href="#figure_8">Figure
	  9</a>. These planes are initially color-mapped to reflect the
	principal eigenvector direction, using a standard (X,Y,Z) -&gt;
	(R,G,B) mapping. Saturation of colors has been modulated by fractional
	anisotropy, and areas outside of the gray and white matter are
	rendered black. The individual cutting planes can be turned on and off
	and their positions can be controlled using the X, Y, Z check-buttons
	and sliders. Color-mapping of tensor values on planes can be controlled
	using the drop-down menu under "Principle Eigenvector" in the "Color
	Planes Based On" frame. When coloring based on a scalar quantity
	(e.g. Fractional Anisotropy), radio buttons next to the color-map
	swatches become active. For constant coloring, change the specified
	color by clicking on the Color button. The "Clip to Isosurface" button
	is discussed in the next section.  <a name="figure_9" id="figure_9"/>
      </p>

      <center>
	<img border="1"
	  src="figures/biotensor-vis-planes.jpg" 
	  alt="Figure: Cutting Plane Visualization
	  (Default)"/>
	<br/>
	<b>Figure 9: Cutting Plane Visualization
	  (Default).</b>
      </center>
      <br /><br/>

      <a name="section_6_3" id="section_6_3"/>
      <h3>6.3 Isosurface Visualization</h3>

      <p>
	Selecting the Isosurface tab reveals options for generating an
	isosurface from the DT volume. As shown in <a href="#figure_10">Figure
	  10</a>:
      </p>
      <ul>
	<li>
	  <p>Choose whether or not to show the isosurface.</p>
	</li>
	<li>
	  <p>Select which derived metric the isosurface is computing
	    (e.g. Fractional Anisotropy).</p>
	</li>
	<li>
	  <p>Select an isovalue.</p>
	</li>
	<li>
	  <p>Color the isosurface based on: the principle eigenvector direction
	    (and desaturated or colored black as described for the planes, above),
	    another scalar metric (in which case the radio buttons for the
	    color-map swatches are activated), or a constant color (chosen using
	    the "Color" button).</p>
	</li>
	<li>
	  <p>Use the planes as clipping planes to clip the isosurface. Orientation
	    of each clipping plane can be toggled using the Flip buttons.</p>
	</li>
      </ul>

      <a name="figure_10" id="figure_10"/>
      <center>
	<img border="1"
	  src="figures/biotensor-vis-isosurf.jpg" 
	  alt="Figure: Isosurface Visualization."/>
	<br/>
	<b>Figure 10: Isosurface Visualization.</b>
      </center>

      <p>
	Just as planes can be used to clip the isosurface, the isosurface can
	be used to clip the planes. An example of this is shown in <a
	  href="#figure_11">Figure 11</a>. The isosurface value is set low
	(0.01), the "Show Isosurface" button is turned off, and the Planes tab
	has selected the Clip to Isosurface button.
      </p>

      <a name="figure_11" id="figure_11"/>
      <center>
	<img border="1"
	  src="figures/biotensor-vis-clipped-planes.jpg" 
	  alt="Figure: Clipped Planes Visualization."/>
	<br/>
	<b>Figure 11: Clipped Planes Visualization.</b>
      </center>

      <a name="section_6_4" id="section_6_4"/>
      <h3>6.4 Glyph Visualization</h3>

      <p>
	The Glyphs panel allows selection of the type, placement, and coloring
	of tensor glyphs within the volume. The default setting renders box
	glyphs, seeded on the planes and colored based on the
	principle eigenvector direction as shown in <a
	  href="#figure_12">Figure 12</a>. A zoomed-in figure of the
	super-quadric glyphs rendered on the cutting planes is shown in <a
	  href="#figure_13">Figure 13</a>.  In addition to colored-box glyphs,
	the tensors can be rendered as RGB boxes, ellipsoids, or super-quadric
	glyphs. With the controls at the top of the panel, users can select
	the discretization level used for the round glyph shapes (which are
	approximated using triangular meshes), select whether to normalize the
	volume (to 1.0) of each tensor before rendering, and whether to scale
	the volume of each tensor, and whether to exaggerate the anisotropy of
	the tensor (and by how much). Finally, using the options in the "Seed
	At" frame, users can choose where to place the glyphs: at a single
	point (controlled by the position of a sphere widget in the Rendering
	window: use Shift-Left Mouse to select and move widgets), seeded along
	a line specified by a rake widget, seeded on the visible cutting
	planes, or seeded at the grid point located within the prescribed
	isovolume. 
      </p>

      <a name="figure_12" id="figure_12"/>
      <center>
	<img border="1"
	  src="figures/biotensor-vis-boxes.jpg" 
	  alt="Figure: Glyph Box Visualization."/>
	<br/>
	<b>Figure 12: Glyph Box Visualization.</b>
      </center>
      <br/>

      <a name="figure_13" id="figure_13"/>
      <center>
	<img border="1"
	  src="figures/biotensor-vis-sqg.jpg" 
	  alt="Figure: Super-quadric Glyph Visualization."/>
	<br/>
	<b>Figure 13: Super-quadric Glyph Visualization.</b>
      </center>
      <br />

      <a name="section_6_5" id="section_6_5"/>
      <h3>6.5 Fiber Visualization</h3>

      <p>
	As with tensor glyphs, seed locations and colorization options for
	rendering fibers within the brain can be selected. A variety of
	options are shown in <a href="#figure_14">Figure 14</a>, <a
	  href="#Figure_15">Figure 15</a>, and <a href="#figure_16">Figure
	  16</a>. Additionally, a number of parameters can be set that control
	the fiber tracing algorithm. These parameters include:
      </p>
      <ul>
	<li>
	  <p>Fiber Algorithm: trace along the major eigenvector or using the tensor-lines
	    algorithm; choose a step size, and whether to use Euler or RK4
	    (fourth-order Runge-Kutta) integration.
	  </p>
	</li>
	<li>
	  <p>Sampling Kernel: choose the interpolation kernel to be used when
	    querying tensor values between discrete sample locations (Tent,
	    Catmull-Rom, or B-Spline).</p>
	</li>
	<li>
	  <p>Stopping Criteria: choose a set of criteria that can be evaluated to
	    determine whether to terminate a fiber. If any of the criteria are
	    true, the fiber will terminate. These criteria include: exceeding a
	    specified maximum fiber length, exceeding a maximum number of steps,
	    and entering a region of the volume that falls below a specified
	    anisotropy threshold (either Linear Anisotropy or Fractional
	    Anisotropy).</p>
	</li>
      </ul>

      <a name="figure_14" id="figure_14"/>
      <center>
	<img border="1"
	  src="figures/biotensor-vis-fibers.jpg" 
	  alt="Figure: Fiber Visualization."/>
	<br/>
	<b>Figure 14: Fiber Visualization.</b>
      </center>
      <br/><br/>

      <a name="figure_15" id="figure_15"/>
      <center>
	<img border="1"
	  src="figures/biotensor-vis-single-fiber.jpg" 
	  alt="Figure: Single Fiber."/>
	<br/>
	<b>Figure 15: Single Fiber.</b>
      </center>
      <br/><br/>

      <a name="figure_16" id="figure_16"/>
      <center>
	<img border="1"
	  src="figures/biotensor-vis-planes-fibers.jpg" 
	  alt="Figure: Planes and Fibers."/>
	<br/>
	<b>Figure 16: Planes and Fibers.</b>
      </center>
      <br/><br/>

      <a id="appendix_a" name="appendix_a" />
      <h2>Appendix A&mdash;Image Formats and Preparation</h2>
      <p>
	BioTensor supports NRRD, DICOM, and Analyze data formats.  The <a
	  href="http://teem.sourceforge.net/nrrd/index.html">NRRD</a>, <a
	  href="http://www.amiravis.com/usersguide/HxFileFormat_DICOM.html">DICOM</a>,
	and <a
	  href="http://www.mrc-cbu.cam.ac.uk/Imaging/analyze_fmt.htm">Analyze</a>
	web sites describe their repspective formats in detail.  This Appendix
	describes how DWI and B0 volume data should be prepared using these
	formats.
      </p>

      <p>
	NRRD and DICOM files should be prepared as follows: The DWI volume
	should be constructed as a 4-dimensional array (several 3-D channel
	volumes stacked contiguously in memory). The reference data (B0)
	volume should consist of a 3-dimensional array with the same
	dimensions as one of the DWI channels. For example, for an axial scan
	with 128x256 in-plane resolution, 90 slices, and 12
	diffusion-weightings, the DWI volume would be stored as one contiguous
	12x128x256x90 dataset (in terms of data-ordering, the 90 axis is
	changing "fastest", i.e. the data is stored as 12 volumes (each
	128x256x90) concatenated together into one big array), and the B0
	volume would have dimensions 128x256x90.
      </p>

      <p>
        BioTensor can also accept a single file containing the DWI volume
        and B0 image. For this case, select the &quot;B0 Reference Data and
        DWI (single file)&quot radiobutton in the Load Data tab. When this
        load method is selected, users must also specify the number of 
        DWI channels in the data and whether the volume is ordered so that
        the volumes are changing fastest (i.e 128.256x90x13) or the z slices are changing
        fastest (i.e. 13x128x256x90). When loading a single file containg the DWI and B0
        data, the user must also indicate whether or not the B0 slices are
        located before or after the DWI slices.
      </p>

      <p>
	For DICOM data, a collection of sequences (directories) that make up
	the DWI and reference volumes must be identified.
      </p>

      <a id="appendix_b" name="appendix_b"/>
      <h2>Appendix B&mdash;B-Matrix File Format</h2>
      
      <p>
	A B-Matrix data file is a plain text file with six numbers per
	line. Lines beginning with the pound character ("#") are
	treated as comments.
      </p>
      <p>
	The six floating-point values per line convey the
	B-matrix for a single DWI.
      </p>
      <p>
	The ordering of the B-matrix elements per line is:
	Bxx Bxy Bxz Byy Byz Bzz
      </p>
      <p>
	The off-diagonal elements of the B-matrix have NOT been pre-multiplied
	by two. This multiplication is done internally, to account for how the
	off-diagonal elements of the diffusion tensor are actually weighted in
	each DWI.
      </p>

      <center>
	<img src="images/footer.gif" alt="Bottom Banner"/><br />
      </center>
    </div>
  </body>
</html>
